<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>E-Fatura XML Oluşturucu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">  
</head>
<body>
    <div class="element">
        <img src="{{ url_for('static', filename='videos/dance.gif') }}" alt="Dancing Figure" width="150" height="150">
    </div>
    <div class="container">
        <video autoplay muted loop height="80%" width="35%" >
            <source src="{{ url_for('static', filename='videos/dance.mp4') }}" type="video/mp4">
        </video>
        <div class="inside">
            <h1>E-Fatura Dosyası Yükle</h1>
            
            <form id="uploadForm"method="POST" enctype="multipart/form-data">
                <input class="sparkle_input" type="file" name="files" accept=".pdf,.jpg,.png" multiple required>
                <br>
                <button type="button" id="previewBtn">Önizleme Yap</button>
                <button type="button" id="saveBtn" disabled>XML Oluştur</button>
                
            </form>
            <div id="preview"></div>
            
        </div>
        <br>
        <video autoplay muted loop height="80%" width="35%"  >
            <source src="{{ url_for('static', filename='videos/dance.mp4') }}" type="video/mp4">
        </video>
    </div>

    <div class="element-alt">
        <img src="{{ url_for('static', filename='videos/dance.gif') }}" alt="Dancing Figure" width="150" height="150">
    </div>

    <div id="popup" style="
        display:none;
        text-align: center;
        position:fixed;
        width:18%;
        height: 5%;
        top:20px;
        right:20px;
        background:#4CAF50;
        color:white;
        padding:15px;
        border-radius:10px;
        box-shadow:0px 0px 10px rgba(0,0,0,0.3);
        z-index:1000;">
        
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("uploadForm");
            const previewBtn = document.getElementById("previewBtn");
            const saveBtn = document.getElementById("saveBtn");
            const preview = document.getElementById("preview");
            const popup = document.getElementById("popup");

            let lastInvoices = [];

            previewBtn.addEventListener("click", function() {
                let formData = new FormData(form);

                fetch("/preview", {
                    method: "POST",
                    body: formData
                })
                .then(response => response.json())
                .then(result => {
                    if(result.error){ alert(result.error); return; }

                    lastInvoices = result.invoices;
                    saveBtn.disabled = false;

                    preview.innerHTML = "";
                    lastInvoices.forEach((invoice, index) => {
                        let table = document.createElement("table");
                        table.border = "1";
                        table.style.margin = "20px 0";
                        table.style.borderCollapse = "collapse";

                        let caption = document.createElement("caption");
                        caption.textContent = `Fatura ${index + 1}`;
                        caption.style.fontWeight = "bold";
                        caption.style.color = "black";
                        table.appendChild(caption);

                        for (let key in invoice) {
                            let row = table.insertRow();
                            let cell1 = row.insertCell(0);
                            let cell2 = row.insertCell(1);
                            cell1.textContent = key;
                            cell2.textContent = invoice[key];
                            cell1.style.padding = "8px";
                            cell2.style.padding = "8px";
                            cell1.style.color = "purple";
                            cell2.style.color = "blue";
                        }

                        preview.appendChild(table);
                    });
                })
                .catch(error => { console.error(error); alert("Önizleme sırasında hata oluştu!"); });
            });

            saveBtn.addEventListener("click", function() {
                fetch("/save", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({invoices: lastInvoices})
                })
                .then(response => response.json())
                .then(result => {
                    popup.textContent = result.message;
                    popup.style.display = "block";
                    setTimeout(() => { popup.style.display = "none"; }, 3000);
                })
                .catch(error => { console.error(error); alert("XML kaydedilirken hata oluştu!"); });
            });
        });
    </script>
    
</body>
</html>